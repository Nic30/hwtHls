from typing import Callable, Dict, Union, Tuple

from hwt.hdl.operator import Operator
from hwt.hdl.operatorDefs import AllOps
from hwt.serializer.resourceAnalyzer.resourceTypes import ResourceFF, RtlResourceType
from hwtHls.platform.interpolations import Spline, ResourceSplineBundle
from hwtHls.platform.xilinx.abstract import AbstractXilinxPlatform
from hwtHls.code import OP_ASHR, OP_LSHR, OP_SHL, OP_CTLZ, OP_CTTZ, OP_CTPOP,\
    OP_FSHL, OP_FSHR


class Artix7Slow(AbstractXilinxPlatform):

    def _init_coefs(self):
        AddSubnS = ResourceSplineBundle(Spline(
            (2.0, 4.0, 8.0, 16.0, 32.0, 40.0, 50.0, 64.0, 128.0, 190.0, 256.0, 320.0, 384.0, 448.0, 512.0, 640.0, 768.0, 896.0, 1024.0, 1280.0, 1536.0, 1792.0, 2048.0, 2560.0, 3072.0, 3584.0, 4096.0),
            (1.5840000000000001e-09, 1.777e-09, 2.1150000000000002e-09, 2.1460000000000002e-09, 2.702e-09, 2.882e-09, 3.1940000000000003e-09, 3.56e-09, 5.39e-09, 7.197000000000001e-09, 9.046e-09, 1.0366e-08, 1.2244e-08, 1.4012000000000002e-08, 1.5895e-08, 1.9520000000000002e-08, 2.3302000000000002e-08, 2.9117000000000002e-08, 3.355700000000001e-08, 4.2241e-08, 5.0941000000000006e-08, 6.121500000000001e-08, 6.976900000000001e-08, 8.818800000000001e-08, 1.06148e-07, 1.2499400000000001e-07, 1.43341e-07)),)
        Cmp = ResourceSplineBundle(Spline(
            (2.0, 4.0, 8.0, 16.0, 32.0, 40.0, 50.0, 64.0, 128.0, 190.0, 256.0, 350.0, 512.0),
            (9.370000000000002e-10, 1.44e-09, 1.4750000000000002e-09, 2.38e-09, 2.4380000000000005e-09, 2.6480000000000004e-09, 2.764e-09, 2.8380000000000003e-09, 3.4270000000000003e-09, 4.1520000000000006e-09, 4.700000000000001e-09, 3.741e-09, 3.853000000000001e-09)),)
        DivnS = ResourceSplineBundle(Spline(
            (2.0, 4.0, 6.0, 8.0, 10.0, 16.0, 29.0, 32.0, 40.0, 50.0, 64.0),
            (2.137e-09, 2.3630000000000002e-09, 3.865e-09, 4.039e-09, 3.091e-09, 3.6890000000000004e-09, 4.04e-09, 4.1570000000000004e-09, 4.391e-09, 4.665e-09, 5.0930000000000005e-09)),)
        LogicGate = ResourceSplineBundle(Spline(
            (2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 10.0, 12.0, 14.0, 16.0, 20.0, 24.0, 28.0, 32.0, 40.0, 48.0, 56.0, 64.0, 80.0, 96.0, 112.0, 128.0, 160.0, 192.0, 224.0, 256.0, 320.0, 384.0, 448.0, 512.0, 640.0, 768.0, 896.0, 1024.0, 1280.0, 1536.0, 1792.0, 2048.0, 2560.0, 3072.0, 3584.0),
            (9.780000000000001e-10, 9.9e-10, 9.71e-10, 9.800000000000001e-10, 9.67e-10, 9.75e-10, 9.75e-10, 9.9e-10, 9.75e-10, 9.92e-10, 9.9e-10, 9.95e-10, 9.95e-10, 9.93e-10, 9.95e-10, 9.93e-10, 9.95e-10, 9.95e-10, 9.93e-10, 9.95e-10, 9.95e-10, 9.93e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10, 9.95e-10)),)
        MulnS = ResourceSplineBundle(Spline(
            (2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 16.0, 19.0, 20.0, 21.0, 22.0, 25.0, 32.0, 36.0, 38.0, 40.0, 45.0, 50.0, 60.0, 64.0, 80.0, 96.0, 128.0, 180.0, 256.0),
            (1.2800000000000001e-09, 1.5600000000000002e-09, 2.0499999999999997e-09, 3.4800000000000004e-09, 3.83e-09, 3.6900000000000003e-09, 4.3700000000000004e-09, 4.46e-09, 4.730000000000001e-09, 5.620000000000001e-09, 5.57e-09, 5.57e-09, 5.85e-09, 6.4900000000000005e-09, 6.4200000000000006e-09, 6.77e-09, 8.47e-09, 8.460000000000001e-09, 8.670000000000001e-09, 8.52e-09, 1.046e-08, 1.026e-08, 1.2470000000000002e-08, 1.237e-08, 1.461e-08, 1.562e-08, 1.851e-08, 4.916e-08, 8.184000000000001e-08)),)
        MuxnS = ResourceSplineBundle(Spline(
            (2.0, 6.0, 16.0, 17.0, 22.0, 31.0, 40.0, 64.0, 82.0, 96.0, 110.0, 128.0, 256.0, 512.0),
            (1.637e-09, 2.0855e-09, 2.081e-09, 2.752e-09, 3.029e-09, 3.0350000000000004e-09, 2.979e-09, 3.1345000000000003e-09, 3.6080000000000004e-09, 3.5955000000000003e-09, 3.4555e-09, 3.7110000000000005e-09, 3.9820000000000005e-09, 4.839499999999999e-09)),)
        Sel = ResourceSplineBundle(Spline(
            (2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 10.0, 12.0, 14.0, 16.0, 20.0, 24.0, 28.0, 32.0, 40.0, 48.0, 56.0, 64.0, 80.0, 96.0, 112.0, 128.0, 160.0, 192.0, 224.0, 256.0, 320.0, 384.0, 448.0, 512.0, 640.0, 768.0, 896.0, 1024.0, 1280.0, 1536.0, 1792.0, 2048.0, 2560.0, 3072.0, 3584.0, 4096.0),
            (9.93e-10, 9.800000000000001e-10, 9.9e-10, 1.2170000000000002e-09, 6.690000000000001e-10, 9.9e-10, 1.041e-09, 1.1270000000000001e-09, 6.820000000000001e-10, 6.98e-10, 1.293e-09, 1.395e-09, 8.38e-10, 1.387e-09, 7.96e-10, 1.0740000000000002e-09, 9.56e-10, 1.53e-09, 9.87e-10, 1.399e-09, 1.732e-09, 1.196e-09, 1.2609999999999999e-09, 1.24e-09, 1.147e-09, 1.4770000000000002e-09, 1.302e-09, 1.6160000000000002e-09, 1.6060000000000002e-09, 2.3780000000000003e-09, 1.8400000000000003e-09, 1.7960000000000002e-09, 1.8380000000000003e-09, 1.942e-09, 1.8460000000000002e-09, 2.121e-09, 2.096e-09, 2.2740000000000002e-09, 2.224e-09, 2.408e-09, 3.2100000000000003e-09, 3.3960000000000003e-09, 3.1950000000000002e-09)),)
        self._OP_DELAYS: Dict[Union[Operator, RtlResourceType], Callable[[int, int, int, float], Tuple[int, float]]] = {
            AllOps.ADD: AddSubnS,
            AllOps.SUB: AddSubnS,
            AllOps.MINUS_UNARY: AddSubnS,
            AllOps.EQ: Cmp,
            AllOps.NE: Cmp,
            AllOps.UGE: Cmp,
            AllOps.UGT: Cmp,
            AllOps.ULE: Cmp,
            AllOps.ULT: Cmp,
            AllOps.SGE: Cmp,
            AllOps.SGT: Cmp,
            AllOps.SLE: Cmp,
            AllOps.SLT: Cmp,
            AllOps.UDIV: DivnS,
            AllOps.SDIV: DivnS,
            AllOps.AND: LogicGate,
            AllOps.OR: LogicGate,
            AllOps.XOR: LogicGate,
            AllOps.NOT: LogicGate,
            AllOps.MUL: MulnS,
            AllOps.TERNARY: MuxnS,
            OP_ASHR: MuxnS,
            OP_LSHR: MuxnS,
            OP_SHL: MuxnS,
            OP_CTLZ: MuxnS,
            OP_CTTZ: MuxnS,
            OP_CTPOP: MuxnS,
            OP_FSHL: MuxnS,
            OP_FSHR: MuxnS,
            ResourceFF: Sel
        }


class Artix7Medium(AbstractXilinxPlatform):

    def _init_coefs(self):
        AddSubnS = ResourceSplineBundle(Spline(
            (2.0, 4.0, 8.0, 16.0, 32.0, 40.0, 50.0, 64.0, 128.0, 190.0, 256.0, 320.0, 384.0, 448.0, 512.0, 640.0, 768.0, 896.0, 1024.0, 1280.0, 1536.0, 1792.0, 2048.0, 2560.0, 3072.0, 3584.0, 4096.0),
            (1.202e-09, 1.4910000000000001e-09, 1.7190000000000002e-09, 1.8400000000000003e-09, 2.1800000000000003e-09, 2.3820000000000003e-09, 2.658e-09, 2.9980000000000006e-09, 4.565000000000001e-09, 6.119e-09, 7.717e-09, 8.936e-09, 1.0459e-08, 1.2073000000000002e-08, 1.3655e-08, 1.6799e-08, 1.996e-08, 2.4696e-08, 2.8607000000000003e-08, 3.5975e-08, 4.3347000000000004e-08, 5.171800000000001e-08, 5.9302000000000004e-08, 7.5374e-08, 9.0134e-08, 1.0582400000000001e-07, 1.21967e-07)),)
        Cmp = ResourceSplineBundle(Spline(
            (2.0, 4.0, 8.0, 16.0, 32.0, 40.0, 50.0, 64.0, 128.0, 190.0, 256.0, 350.0, 512.0),
            (7.94e-10, 1.21e-09, 1.2490000000000001e-09, 1.977e-09, 2.1110000000000003e-09, 2.1570000000000003e-09, 2.3460000000000004e-09, 2.3410000000000005e-09, 2.9100000000000005e-09, 3.3180000000000003e-09, 3.911e-09, 3.1010000000000004e-09, 3.171e-09)),)
        DivnS = ResourceSplineBundle(Spline(
            (2.0, 4.0, 6.0, 8.0, 10.0, 16.0, 32.0, 40.0, 50.0, 64.0),
            (1.73e-09, 1.908e-09, 3.135e-09, 3.2910000000000003e-09, 2.487e-09, 2.9980000000000006e-09, 3.3980000000000005e-09, 3.598e-09, 3.819e-09, 4.198000000000001e-09)),)
        LogicGate = ResourceSplineBundle(Spline(
            (2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 10.0, 12.0, 14.0, 20.0, 24.0, 28.0, 32.0, 40.0, 48.0, 56.0, 64.0, 80.0, 96.0, 112.0, 128.0, 160.0, 192.0, 224.0, 256.0, 320.0, 384.0, 448.0, 512.0, 640.0, 768.0, 896.0, 1024.0, 1280.0, 1536.0, 1792.0, 2048.0, 2560.0, 3584.0, 4096.0),
            (8.000000000000001e-10, 8.060000000000001e-10, 7.95e-10, 7.95e-10, 7.880000000000001e-10, 8.000000000000001e-10, 8.000000000000001e-10, 8.730000000000001e-10, 8.000000000000001e-10, 8.070000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.080000000000001e-10, 8.090000000000001e-10, 8.080000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.080000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.080000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.090000000000001e-10, 8.470000000000001e-10, 8.44e-10)),)
        MulnS = ResourceSplineBundle(Spline(
            (2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 16.0, 19.0, 20.0, 21.0, 22.0, 32.0, 36.0, 38.0, 40.0, 45.0, 50.0, 60.0, 64.0, 80.0, 96.0, 128.0, 180.0, 256.0),
            (1.07e-09, 1.29e-09, 1.78e-09, 3.01e-09, 3.2100000000000003e-09, 3.2900000000000004e-09, 3.63e-09, 3.54e-09, 3.78e-09, 4.64e-09, 4.62e-09, 4.64e-09, 4.8800000000000005e-09, 5.21e-09, 5.22e-09, 6.88e-09, 7.160000000000001e-09, 7.25e-09, 7.12e-09, 8.740000000000001e-09, 8.960000000000002e-09, 1.034e-08, 1.045e-08, 1.1820000000000001e-08, 1.272e-08, 1.504e-08, 4.137e-08, 6.656000000000001e-08)),)
        MuxnS = ResourceSplineBundle(Spline(
            (2.0, 4.0, 6.0, 16.0, 17.0, 29.0, 32.0, 40.0, 64.0, 96.0, 110.0, 128.0, 256.0, 512.0),
            (1.3370000000000002e-09, 1.4210000000000002e-09, 1.815e-09, 1.8255e-09, 2.218e-09, 2.795e-09, 2.453e-09, 2.5505000000000002e-09, 2.6115000000000003e-09, 2.984e-09, 2.8875000000000002e-09, 2.9725000000000002e-09, 3.278e-09, 3.889e-09)),)
        Sel = ResourceSplineBundle(Spline(
            (2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 10.0, 12.0, 14.0, 16.0, 20.0, 24.0, 28.0, 32.0, 40.0, 48.0, 56.0, 64.0, 80.0, 96.0, 112.0, 128.0, 160.0, 192.0, 224.0, 256.0, 320.0, 384.0, 448.0, 512.0, 640.0, 768.0, 896.0, 1024.0, 1280.0, 1536.0, 1792.0, 2048.0, 2560.0, 3072.0, 3584.0, 4096.0),
            (8.13e-10, 7.95e-10, 8.060000000000001e-10, 9.860000000000001e-10, 5.87e-10, 8.060000000000001e-10, 1.0760000000000002e-09, 1.064e-09, 5.96e-10, 6.16e-10, 1.064e-09, 5.85e-10, 1.134e-09, 7.290000000000001e-10, 7.73e-10, 7.880000000000001e-10, 7.320000000000001e-10, 7.820000000000001e-10, 8.31e-10, 1.1370000000000001e-09, 8.820000000000001e-10, 1.093e-09, 1.4950000000000001e-09, 9.39e-10, 9.92e-10, 1.039e-09, 1.5720000000000002e-09, 1.246e-09, 1.385e-09, 1.416e-09, 1.448e-09, 1.4370000000000001e-09, 1.519e-09, 1.6750000000000001e-09, 1.6140000000000002e-09, 1.6730000000000001e-09, 1.722e-09, 2.008e-09, 1.9710000000000003e-09, 1.961e-09, 2.682e-09, 2.772e-09, 2.8290000000000005e-09)),)
        self._OP_DELAYS: Dict[Union[Operator, RtlResourceType], Callable[[int, int, int, float], Tuple[int, float]]] = {
            AllOps.ADD: AddSubnS,
            AllOps.SUB: AddSubnS,
            AllOps.MINUS_UNARY: AddSubnS,
            AllOps.EQ: Cmp,
            AllOps.NE: Cmp,
            AllOps.UGE: Cmp,
            AllOps.UGT: Cmp,
            AllOps.ULE: Cmp,
            AllOps.ULT: Cmp,
            AllOps.SGE: Cmp,
            AllOps.SGT: Cmp,
            AllOps.SLE: Cmp,
            AllOps.SLT: Cmp,
            AllOps.UDIV: DivnS,
            AllOps.SDIV: DivnS,
            AllOps.AND: LogicGate,
            AllOps.OR: LogicGate,
            AllOps.XOR: LogicGate,
            AllOps.NOT: LogicGate,
            AllOps.MUL: MulnS,
            AllOps.TERNARY: MuxnS,
            ResourceFF: Sel
        }


class Artix7Fast(AbstractXilinxPlatform):

    def _init_coefs(self):
        AddSubnS = ResourceSplineBundle(Spline(
            (2.0, 4.0, 8.0, 16.0, 32.0, 40.0, 50.0, 64.0, 128.0, 190.0, 256.0, 320.0, 384.0, 448.0, 512.0, 640.0, 768.0, 896.0, 1024.0, 1280.0, 1536.0, 1792.0, 2048.0, 2560.0, 3072.0, 4096.0),
            (1.097e-09, 1.45e-09, 1.761e-09, 1.775e-09, 2.007e-09, 2.215e-09, 2.405e-09, 2.706e-09, 4.1300000000000004e-09, 5.532e-09, 6.988000000000001e-09, 8.112e-09, 9.548e-09, 1.0961000000000001e-08, 1.2398000000000001e-08, 1.5253e-08, 1.8096000000000002e-08, 2.2453e-08, 2.5973e-08, 3.2819000000000004e-08, 3.9557e-08, 4.6899e-08, 5.3922e-08, 6.837300000000001e-08, 8.1624e-08, 1.1027500000000001e-07)),)
        Cmp = ResourceSplineBundle(Spline(
            (2.0, 4.0, 8.0, 16.0, 32.0, 40.0, 50.0, 64.0, 128.0, 190.0, 256.0, 350.0, 512.0),
            (7.07e-10, 1.071e-09, 1.0780000000000002e-09, 1.857e-09, 1.8620000000000002e-09, 1.864e-09, 2.006e-09, 2.094e-09, 2.6800000000000003e-09, 2.988e-09, 3.526e-09, 2.787e-09, 2.96e-09)),)
        DivnS = ResourceSplineBundle(Spline(
            (2.0, 4.0, 6.0, 8.0, 10.0, 16.0, 32.0, 40.0, 50.0, 64.0),
            (1.525e-09, 1.6980000000000001e-09, 2.7730000000000002e-09, 2.909e-09, 2.2000000000000003e-09, 2.6480000000000004e-09, 3.0160000000000003e-09, 3.2000000000000005e-09, 3.416e-09, 3.752e-09)),)
        LogicGate = ResourceSplineBundle(Spline(
            (2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 10.0, 12.0, 14.0, 16.0, 20.0, 28.0, 32.0, 48.0, 56.0, 64.0, 80.0, 96.0, 112.0, 128.0, 160.0, 192.0, 224.0, 256.0, 320.0, 384.0, 448.0, 512.0, 768.0, 896.0),
            (7.12e-10, 7.16e-10, 6.860000000000001e-10, 7.05e-10, 7.01e-10, 7.12e-10, 7.12e-10, 7.550000000000001e-10, 7.12e-10, 7.17e-10, 7.16e-10, 7.21e-10, 7.19e-10, 7.21e-10, 7.21e-10, 7.21e-10, 7.19e-10, 7.21e-10, 7.21e-10, 7.19e-10, 7.21e-10, 7.21e-10, 7.21e-10, 7.21e-10, 7.21e-10, 7.21e-10, 7.21e-10, 7.21e-10, 7.21e-10, 7.21e-10, 7.21e-10)),)
        MulnS = ResourceSplineBundle(Spline(
            (2.0, 3.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 16.0, 19.0, 20.0, 21.0, 22.0, 25.0, 32.0, 36.0, 38.0, 40.0, 45.0, 50.0, 60.0, 64.0, 80.0, 96.0, 128.0, 180.0, 256.0),
            (9.6e-10, 1.15e-09, 2.67e-09, 2.86e-09, 2.98e-09, 3.42e-09, 3.4300000000000004e-09, 3.7200000000000004e-09, 4.06e-09, 4.06e-09, 4.07e-09, 4.28e-09, 4.65e-09, 4.66e-09, 4.76e-09, 6.12e-09, 6.400000000000001e-09, 6.3e-09, 6.4200000000000006e-09, 7.440000000000001e-09, 7.54e-09, 9.04e-09, 9.010000000000001e-09, 1.0510000000000001e-08, 1.121e-08, 1.3580000000000001e-08, 3.5990000000000007e-08, 5.7720000000000003e-08)),)
        MuxnS = ResourceSplineBundle(Spline(
            (2.0, 6.0, 16.0, 17.0, 22.0, 31.0, 40.0, 64.0, 96.0, 110.0, 128.0, 256.0, 512.0),
            (1.2105000000000001e-09, 1.5795e-09, 1.654e-09, 1.9680000000000002e-09, 2.174e-09, 2.178e-09, 2.3630000000000002e-09, 2.408e-09, 2.7485e-09, 2.665e-09, 2.7665e-09, 2.9645000000000003e-09, 3.4515000000000003e-09)),)
        Sel = ResourceSplineBundle(Spline(
            (2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 10.0, 12.0, 14.0, 16.0, 20.0, 24.0, 28.0, 32.0, 40.0, 48.0, 56.0, 64.0, 80.0, 96.0, 112.0, 128.0, 160.0, 192.0, 224.0, 256.0, 320.0, 384.0, 448.0, 512.0, 640.0, 768.0, 896.0, 1024.0, 1280.0, 1536.0, 1792.0, 2048.0, 2560.0, 3072.0, 3584.0, 4096.0),
            (7.23e-10, 7.05e-10, 7.16e-10, 8.69e-10, 4.930000000000001e-10, 7.16e-10, 9.550000000000001e-10, 5.140000000000001e-10, 5.190000000000001e-10, 6.21e-10, 9.38e-10, 5.170000000000001e-10, 1.003e-09, 5.34e-10, 6.660000000000001e-10, 7.7e-10, 7.36e-10, 1.2450000000000001e-09, 8.4e-10, 1.051e-09, 1.297e-09, 1.4e-09, 1.244e-09, 9.72e-10, 1.016e-09, 1.003e-09, 1.384e-09, 1.113e-09, 1.2200000000000001e-09, 1.291e-09, 1.2780000000000001e-09, 1.337e-09, 1.353e-09, 1.4790000000000002e-09, 1.4210000000000002e-09, 1.5640000000000002e-09, 1.5540000000000002e-09, 1.8530000000000001e-09, 1.908e-09, 2.023e-09, 2.403e-09, 2.6610000000000002e-09, 2.67e-09)),)
        self._OP_DELAYS: Dict[Union[Operator, RtlResourceType], Callable[[int, int, int, float], Tuple[int, float]]] = {
            AllOps.ADD: AddSubnS,
            AllOps.SUB: AddSubnS,
            AllOps.MINUS_UNARY: AddSubnS,
            AllOps.EQ: Cmp,
            AllOps.NE: Cmp,
            AllOps.UGE: Cmp,
            AllOps.UGT: Cmp,
            AllOps.ULE: Cmp,
            AllOps.ULT: Cmp,
            AllOps.SGE: Cmp,
            AllOps.SGT: Cmp,
            AllOps.SLE: Cmp,
            AllOps.SLT: Cmp,
            AllOps.UDIV: DivnS,
            AllOps.SDIV: DivnS,
            AllOps.AND: LogicGate,
            AllOps.OR: LogicGate,
            AllOps.XOR: LogicGate,
            AllOps.NOT: LogicGate,
            AllOps.MUL: MulnS,
            AllOps.TERNARY: MuxnS,
            ResourceFF: Sel
        }

